

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="Python" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="Python" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gridwxcomp.interpgdal &mdash; gridwxcomp 0.0.65 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/copybutton.js"></script>
        <script type="text/javascript" src="../../_static/custom.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> gridwxcomp
          

          
          </a>

          
            
            
              <div class="version">
                0.0.65
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#quick-start-from-command-line">Quick start from command line</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#command-line-interface">Command Line Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp">gridwxcomp</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp-prep-input">gridwxcomp prep-input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp-download-gridmet-ee">gridwxcomp download-gridmet-ee</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp-spatial">gridwxcomp spatial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp-plot">gridwxcomp plot</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#python-functions-classes-and-modules">Python functions, classes, and modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#prep-input">prep_input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#download-gridmet-ee">download_gridmet_ee</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#module-gridwxcomp.calc_bias_ratios">calc_bias_ratios</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#module-gridwxcomp.spatial">spatial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#module-gridwxcomp.plot">plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#interpgdal">InterpGdal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#module-gridwxcomp.util">util</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change Log</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-6">Version 0.0.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-5">Version 0.0.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-4">Version 0.0.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-3">Version 0.0.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-2">Version 0.0.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-1">Version 0.0.1</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">gridwxcomp</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>gridwxcomp.interpgdal</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gridwxcomp.interpgdal</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains objects for interfacing ``gridwxcomp`` with gdal command line tools</span>
<span class="sd">used for spatial interpolation of scattered point data.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">xml.dom</span> <span class="k">import</span> <span class="n">minidom</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># allows for CL script usage if gridwxcomp not installed</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.spatial</span> <span class="k">import</span> <span class="n">get_subgrid_bounds</span><span class="p">,</span> <span class="n">gridmet_zonal_stats</span><span class="p">,</span> <span class="n">calc_pt_error</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">spatial</span> <span class="k">import</span> <span class="n">get_subgrid_bounds</span><span class="p">,</span> <span class="n">gridmet_zonal_stats</span><span class="p">,</span> <span class="n">calc_pt_error</span>

<div class="viewcode-block" id="InterpGdal"><a class="viewcode-back" href="../../api.html#gridwxcomp.InterpGdal">[docs]</a><span class="k">class</span> <span class="nc">InterpGdal</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Usage of gdal command line tools within ``gridwxcomp``, currently</span>
<span class="sd">    utilizes the `gdal_grid &lt;https://www.gdal.org/gdal_grid.html&gt;`_ </span>
<span class="sd">    command line tool. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        summary_csv_path (str): path to [var]_summary_comp CSV file created </span>
<span class="sd">            by :mod:`gridwxcomp.calc_bias_ratios` containing point bias ratios,</span>
<span class="sd">            lat, and long. </span>
<span class="sd">            </span>
<span class="sd">    Attributes:</span>
<span class="sd">        CELL_SIZE (float): resolution of gridMET dataset in decimal degrees.</span>
<span class="sd">        interp_methods (tuple): gdal_grid interpolation algorithms.</span>
<span class="sd">        default_layers (tuple): layers to interpolate created by </span>
<span class="sd">            :mod:`gridwxcomp.calc_bias_ratios`, e.g. &quot;Jan_mean&quot;, found in </span>
<span class="sd">            ``summary_csv_path``.</span>
<span class="sd">        default_params (dict): dictionary with default parameters for each</span>
<span class="sd">            interpolation algorithm, slightly modified from gdal defaults.</span>
<span class="sd">            Keys are interpolation method names, keys are dictionaries with</span>
<span class="sd">            parameter names keys and corresponding values.</span>
<span class="sd">        summary_csv_path (:obj:`pathlib.Path`): absolute path object to </span>
<span class="sd">            input ``summary_csv_path``.</span>
<span class="sd">        layers (list): list of layers in ``summary_csv_path`` to interpolate</span>
<span class="sd">            e.g. when using :meth:`InterpGdal.gdal_grid` with ``layer=&quot;all&quot;``</span>
<span class="sd">            defaults to :attr:`InterpGdal.default_layers`.</span>
<span class="sd">        grid_bounds (tuple or None): default None. Extent for interpolation</span>
<span class="sd">            raster in order (min long, max long, min lat, max lat).</span>
<span class="sd">        interp_meth (str): default &#39;invdist&#39;. gdal_grid interpolation method.</span>
<span class="sd">        interped_rasters (list): empty list that is appended with </span>
<span class="sd">            :obj:`pathlib.Path` objects to interpolated rasters after using</span>
<span class="sd">            :meth:`InterpGdal.gdal_grid`.</span>
<span class="sd">        params (dict or None): default None. After :meth:`InterpGdal.gdal_grid`</span>
<span class="sd">            ``params`` is updated with the last used interpolation parameters</span>
<span class="sd">            in the form of a dictionary with parameter names as keys.</span>
<span class="sd">            </span>
<span class="sd">    Example:</span>
<span class="sd">        The :class:`InterpGdal` class is useful for experimenting with multiple </span>
<span class="sd">        interpolation algorithms provided by gdal which are optimized and</span>
<span class="sd">        often sensitive to multiple parameters. We can use the object</span>
<span class="sd">        to loop over a range of parameter combinations to test how algorithms</span>
<span class="sd">        perform, we might pick a single layer to test, in this case the</span>
<span class="sd">        growing season bias ratios between station and gridMET reference</span>
<span class="sd">        evapotranspiration (etr_mm). Below is a routine to conduct a</span>
<span class="sd">        basic sensitivity analysis of the power and smooth parameters of the </span>
<span class="sd">        inverse distance to a power interpolation method,</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; from gridwxcomp import InterpGdal</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; # create instance variable from summary csv</span>
<span class="sd">        &gt;&gt;&gt; summary_file = &#39;PATH/TO/etr_mm_summary_comp.csv&#39;</span>
<span class="sd">        &gt;&gt;&gt; # create a InterpGdal instance</span>
<span class="sd">        &gt;&gt;&gt; test = InterpGdal(summary_file)</span>
<span class="sd">        &gt;&gt;&gt; layer = &#39;growseason_mean&#39; # could be a list</span>
<span class="sd">        &gt;&gt;&gt; # run inverse distance interpolation with different params</span>
<span class="sd">        &gt;&gt;&gt; for p in range(1,10):</span>
<span class="sd">        &gt;&gt;&gt;     for s in [0, 0.5, 1, 1.5, 2]:</span>
<span class="sd">        &gt;&gt;&gt;         # build output directory based on parameter sets</span>
<span class="sd">        &gt;&gt;&gt;         out_dir = os.path.join(&#39;spatial&#39;, &#39;invdist&#39;, </span>
<span class="sd">        &gt;&gt;&gt;             &#39;power={}_smooth={}&#39;.format(p, s))</span>
<span class="sd">        &gt;&gt;&gt;         params = {&#39;power&#39;: p, &#39;smooth&#39;: s}</span>
<span class="sd">        &gt;&gt;&gt;         test.gdal_grid(out_dir=out_dir, layer=layer, params=params)</span>

<span class="sd">        Note, we did not assign the interpolation method &#39;invdist&#39; because it </span>
<span class="sd">        is the default. To use another interpolation method we would</span>
<span class="sd">        assign the ``interp_meth`` kwarg to :meth:`InterpGdal.gdal_grid`.</span>
<span class="sd">        Similarly, we could experiment with other parameters which all can be</span>
<span class="sd">        found in the class attribute :attr:`InterpGdal.default_params`. The</span>
<span class="sd">        instance variable :attr:`InterpGdal.params` can also be used to save</span>
<span class="sd">        metadata on parameters used for each run.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># constant gridMET cell size in degrees</span>
    <span class="n">CELL_SIZE</span> <span class="o">=</span> <span class="mf">0.041666666666666664</span>
    <span class="c1"># gdal_grid interpolation methods</span>
    <span class="n">interp_methods</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;invdist&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;invdistnn&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    
    <span class="c1"># default layers calculated by calc bias ratios module</span>
    <span class="n">default_layers</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Jan_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Feb_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Mar_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Apr_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;May_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Jun_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Jul_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Aug_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Sep_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Oct_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Nov_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Dec_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;growseason_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;annual_mean&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;summer_mean&#39;</span><span class="p">)</span>
    
    <span class="c1"># interp params, method key, param dic as values</span>
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;invdist&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;smoothing&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s1">&#39;radius1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;radius2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;max_points&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;min_points&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">999</span>
        <span class="p">},</span>
        <span class="s1">&#39;invdistnn&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;smoothing&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;max_points&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
            <span class="s1">&#39;min_points&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">999</span>
        <span class="p">},</span>
        <span class="s1">&#39;average&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;radius1&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;radius2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;min_points&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">999</span>
        <span class="p">},</span>
        <span class="s1">&#39;linear&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">999</span>
        <span class="p">},</span>
        <span class="s1">&#39;nearest&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;radius1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;radius2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">999</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_csv_path</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s1">&#39;Summary CSV file: </span><span class="si">{}</span><span class="s1"> not found!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">Path</span><span class="p">(</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
            <span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_layers</span><span class="p">)</span> <span class="c1"># mutable instance attr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_meth</span> <span class="o">=</span> <span class="s1">&#39;invdist&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interped_rasters</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># appended with Path objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># to hold last used interp. parameters as dict</span>
        
        
    <span class="k">def</span> <span class="nf">_make_pt_vrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a vrt file for station point ratios in summary CSV for a </span>
<span class="sd">        specific layer or field name. Save to out_dir. Used for gdal_grid </span>
<span class="sd">        interpolation commands of scatter point data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
        <span class="c1"># old method</span>
        <span class="c1">#summary_file = Path(self.summary_csv_path).name</span>
        
        <span class="n">point_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;_tmp.csv&#39;</span><span class="p">)</span>

        <span class="c1"># make tmp point data csv for given layer, drop missing values</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;STATION_LAT&#39;</span><span class="p">,</span> <span class="s1">&#39;STATION_LON&#39;</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">]]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span><span class="p">]</span>
        <span class="n">tmp_out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">point_data</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">tmp_out_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># if out_dir adjust summary CSV path by prepending parent dirs </span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">))</span>
        <span class="n">n_parent_dirs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>    
            <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">n_parent_dirs</span><span class="o">+=</span><span class="mi">1</span>
        
        <span class="n">path_to_data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span>
                <span class="s1">&#39;..</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">*</span><span class="n">n_parent_dirs</span>
            <span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">point_data</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">out_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.vrt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span> <span class="c1"># keep it simple just layer name</span>

        <span class="c1"># VRT format for reading CSV point data</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;OGRVRTDataSource&#39;</span><span class="p">)</span>
        <span class="n">OGRVRTLayer</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;OGRVRTLayer&#39;</span><span class="p">,</span> 
                                    <span class="n">name</span><span class="o">=</span><span class="n">point_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="c1"># set all fields, SRS WGS84, point geom</span>
        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">OGRVRTLayer</span><span class="p">,</span> <span class="s1">&#39;SrcDataSource&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">path_to_data</span>
        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">OGRVRTLayer</span><span class="p">,</span> <span class="s1">&#39;LayerSRS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;epsg:4326&#39;</span>
        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">OGRVRTLayer</span><span class="p">,</span> <span class="s1">&#39;GeometryType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;wkbPoint&#39;</span>
        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">OGRVRTLayer</span><span class="p">,</span> <span class="s1">&#39;GeometryField&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;PointFromColumns&#39;</span><span class="p">,</span>
                     <span class="n">x</span><span class="o">=</span><span class="s1">&#39;STATION_LON&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;STATION_LAT&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">layer_name</span><span class="p">)</span>
        
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="c1"># indent xml, save to out_dir</span>
        <span class="n">out_xml_str</span> <span class="o">=</span> <span class="n">_prettify</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_xml_str</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_str_to_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Convert parameter string for gdal interpolation arguments</span>
<span class="sd">        into a dictionary. </span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; in_str = &quot;:power=2:smoothing=.1:nodata=-999&quot;</span>
<span class="sd">            &gt;&gt;&gt; _str_to_params(in_str)</span>
<span class="sd">                {&#39;power&#39;: &#39;2&#39;, &#39;smoothing&#39;: &#39;.1&#39;, &#39;nodata&#39;: &#39;-999&#39;}</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_tmp</span> <span class="o">=</span> <span class="n">param_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">param_tmp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span> <span class="ow">and</span> <span class="n">pair</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">param_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">pair</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid interpolation argument&#39;</span>\
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_str</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">param_dict</span>
    

<div class="viewcode-block" id="InterpGdal.gdal_grid"><a class="viewcode-back" href="../../api.html#gridwxcomp.InterpGdal.gdal_grid">[docs]</a>    <span class="k">def</span> <span class="nf">gdal_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">interp_meth</span><span class="o">=</span><span class="s1">&#39;invdist&#39;</span><span class="p">,</span> 
                  <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nx_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ny_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zonal_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run gdal_grid command line tool to interpolate point ratios.</span>
<span class="sd">        </span>
<span class="sd">        For further information on theinterpolation algorithms including </span>
<span class="sd">        their function, parameters, and options see </span>
<span class="sd">        `gdal_grid &lt;https://www.gdal.org/gdal_grid.html&gt;`_.</span>
<span class="sd">        </span>
<span class="sd">        Keyword Arguments:</span>
<span class="sd">            layer (str or list): default &#39;all&#39;. Name of summary file column</span>
<span class="sd">                to interpolate, e.g. &#39;Jan_mean&#39;, or list of names. If &#39;all&#39;</span>
<span class="sd">                use all variables in mutable instance attribute &quot;layers&quot;.</span>
<span class="sd">            out_dir (str): default &#39;&#39;. Output directory to save rasters and</span>
<span class="sd">                zonal stats CSV, always appended to the root dir of the</span>
<span class="sd">                input summary CSV parent path that contains point ratios.</span>
<span class="sd">            interp_meth (str): default &#39;invdist&#39;. gdal interpolation algorithm</span>
<span class="sd">            params (dict, str, or None): default None. Parameters for </span>
<span class="sd">                interpolation algorithm. See examples for format rules.</span>
<span class="sd">            bounds (tuple or None): default None. Tuple of bounding coordinates </span>
<span class="sd">                in the following order (min long, max long, min lat, max lat) </span>
<span class="sd">                which need to be in decimal degrees. If None, get extent from </span>
<span class="sd">                locations of climate stations in input summary CSV with 25 cell</span>
<span class="sd">                buffer.</span>
<span class="sd">            nx_cells (int): default None. Number of pixels in x dim. of raster,</span>
<span class="sd">                if None calculated from ``bounds``.</span>
<span class="sd">            ny_cells (int): default None. Number of pixels in y dim. of raster,</span>
<span class="sd">                if None calculated from ``bounds``.</span>
<span class="sd">            scale_factor (float, int): default 0.1. Scaling factor to apply to </span>
<span class="sd">                original gridMET fishnet to create resampling resolution. If </span>
<span class="sd">                scale_factor = 0.1, the resolution will be one tenth gridMET </span>
<span class="sd">                resolution or 400 m.</span>
<span class="sd">            zonal_stats (bool): default True. Calculate zonal means of </span>
<span class="sd">                interpolated surface to gridMET cells in fishnet and save to a </span>
<span class="sd">                CSV file. The CSV file will be saved to the same directory as </span>
<span class="sd">                the interpolated raster file(s).</span>
<span class="sd">            options (str or None): default None. Extra command line options for</span>
<span class="sd">                gdal_grid spatial interpolation.</span>
<span class="sd">                </span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">                </span>
<span class="sd">        Examples:</span>
<span class="sd">            The default interpolation algorithm &#39;invdist&#39; or inverse distance </span>
<span class="sd">            weighting to a power to interpolate bias ratios in a summary CSV </span>
<span class="sd">            file that was first created by :mod:`gridwxcomp.calc_bias_ratios`. </span>
<span class="sd">            The default option will interpolate all layers in :obj:`InterpGdal.default_layers` </span>
<span class="sd">            and calculate zonal statistics for all layers. It will also assume </span>
<span class="sd">            the boundaries of the rasters are defined by the centroid locations </span>
<span class="sd">            of the *outer* station locations in the input summary CSV plus a 25 </span>
<span class="sd">            gridMET cell buffer, the pixel size will be 400m (scale_factor=0.1).            We also limit the interpolation to two layers, growing season and </span>
<span class="sd">            annual mean bias ratios,</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; from gridwxcomp import InterpGdal</span>
<span class="sd">            &gt;&gt;&gt; summary_file = &#39;PATH/TO/[var]_summary_comp.csv&#39;</span>
<span class="sd">            &gt;&gt;&gt; out_dir = &#39;default_params&#39;</span>
<span class="sd">            &gt;&gt;&gt; layers = [&#39;growseason_mean&#39;, &#39;annual_mean&#39;]</span>
<span class="sd">            &gt;&gt;&gt; # create a InterpGdal instance</span>
<span class="sd">            &gt;&gt;&gt; test = InterpGdal(summary_file)</span>
<span class="sd">            &gt;&gt;&gt; # run inverse distance interpolation</span>
<span class="sd">            &gt;&gt;&gt; test.gdal_grid(out_dir=out_dir, layer=layers)</span>
<span class="sd">            </span>
<span class="sd">            Note, zonal statistics on gridMET cells in a fishnet grid are </span>
<span class="sd">            calculated by default, to avoid an error the fishnet must have been</span>
<span class="sd">            previously created using :func:`gridwxcomp.spatial.make_grid`. After            running the code above the following files will be created in the </span>
<span class="sd">            &#39;default_params&#39; directory which will be build in the same location</span>
<span class="sd">            as the input summary CSV::</span>
<span class="sd">            </span>
<span class="sd">                default_params/</span>
<span class="sd">                ├── annual_mean.tiff</span>
<span class="sd">                ├── annual_mean.vrt</span>
<span class="sd">                ├── growseason_mean.tiff</span>
<span class="sd">                ├── growseason_mean.vrt</span>
<span class="sd">                └── gridMET_stats.csv</span>

<span class="sd">            GeoTiff interpolated raster files are now created for select layers</span>
<span class="sd">            as well as VRT (virtual raster) meta files that store info</span>
<span class="sd">            on each raster&#39;s data source. The file &quot;gridMET_stats.csv&quot; contains</span>
<span class="sd">            gridMET ID as an index and each layer zonal mean as columns. For</span>
<span class="sd">            example,</span>
<span class="sd">            </span>
<span class="sd">                ========== ================== ================== </span>
<span class="sd">                GRIDMET_ID growseason_mean    annual_mean        </span>
<span class="sd">                ========== ================== ================== </span>
<span class="sd">                511747     0.9650671287940088 0.9078723876243023 </span>
<span class="sd">                510361     0.9658465063428492 0.9097255715561022 </span>
<span class="sd">                508975     0.9667075970344162 0.9117676407214926 </span>
<span class="sd">                ========== ================== ================== </span>
<span class="sd">                </span>
<span class="sd">            On a final note, there are several :class:`InterpGdal` instance</span>
<span class="sd">            attributes that may be useful, for example to see the parameters</span>
<span class="sd">            that were used for the last call to :meth:`InterpGdal.gdal_grid`</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; test.params</span>
<span class="sd">            {&#39;power&#39;: 4,</span>
<span class="sd">             &#39;smoothing&#39;: 0.2,</span>
<span class="sd">             &#39;radius1&#39;: 0,</span>
<span class="sd">             &#39;radius2&#39;: 0,</span>
<span class="sd">             &#39;angle&#39;: 0,</span>
<span class="sd">             &#39;max_points&#39;: 0,</span>
<span class="sd">             &#39;min_points&#39;: 0,</span>
<span class="sd">             &#39;nodata&#39;: -999}</span>
<span class="sd">                 </span>
<span class="sd">            Or to find the paths to the interpolated raster files that</span>
<span class="sd">            have been created by the instance (all), the &quot;interped_rasters&quot;</span>
<span class="sd">            instance attribute is a list of all :obj:`pathlib.Path` objects</span>
<span class="sd">            of absolute paths of raster files. To get them as strings,</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; list(map(str, test.interped_rasters))</span>
<span class="sd">            [&#39;PATH/TO/growseason_mean.tiff&#39;,</span>
<span class="sd">             &#39;PATH/TO/annual_mean.tiff&#39;]</span>
<span class="sd">             </span>
<span class="sd">            Similary, the raster extent that was used and will be used again for</span>
<span class="sd">            any subsequent calls of :meth:`InterpGdal.gdal_grid` can be </span>
<span class="sd">            retrieved by</span>
<span class="sd">             </span>
<span class="sd">            &gt;&gt;&gt; test.grid_bounds </span>
<span class="sd">            (-111.74583329966664,</span>
<span class="sd">             -108.74583330033335,</span>
<span class="sd">             38.21250000003333,</span>
<span class="sd">             40.462499999966674)</span>
<span class="sd">             </span>
<span class="sd">        Note:</span>
<span class="sd">            The ``nx_cells`` and ``ny_cells`` arguments are an option for </span>
<span class="sd">            defining the output raster&#39;s resolution. If these arguments are </span>
<span class="sd">            passed then the ``scale_factor`` argument has no effect. The latter</span>
<span class="sd">            assumes raster resolution is relative to gridMET (4 km). </span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError: if interp_meth is not a valid gdal_grid interpolation</span>
<span class="sd">                algorithm name. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="n">source_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;_tmp&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">interp_meth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">InterpGdal</span><span class="o">.</span><span class="n">interp_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not a valid interpolation method&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">interp_meth</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_meth</span> <span class="o">=</span> <span class="n">interp_meth</span>
            
        <span class="c1"># look up default parameters for interpolation method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">InterpGdal</span><span class="o">.</span><span class="n">default_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_meth</span><span class="p">)</span>
        <span class="c1"># if run from command line, params is string to be parsed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_to_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># avoid zero NA values for zonal_stats, set default NA rep to -999</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nodata&#39;</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
        <span class="c1"># update instance parameters for later reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="c1"># parameters to command line input str :name=value:name=value ...</span>
        <span class="n">param_str</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{!s}</span><span class="s1">=</span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">)</span> 
                                 <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> 
        <span class="c1"># get boundary info and update instance attribute</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bounds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_bounds</span><span class="p">:</span>
            <span class="c1"># use gridwxcomp.spatial function, assume 25 cell buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_bounds</span> <span class="o">=</span> <span class="n">get_subgrid_bounds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">,</span> 
                    <span class="n">buffer</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bounds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_bounds</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="c1"># raster extent</span>
        <span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_bounds</span>
        
        <span class="c1"># if not given get pixels in lon lat using gridMET resolution</span>
        <span class="c1"># add one cell to avoid unfilled extent in case of large upscaling</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nx_cells</span><span class="p">:</span>
            <span class="n">nx_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="p">(</span><span class="n">InterpGdal</span><span class="o">.</span><span class="n">CELL_SIZE</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ny_cells</span><span class="p">:</span>
            <span class="n">ny_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="p">(</span><span class="n">InterpGdal</span><span class="o">.</span><span class="n">CELL_SIZE</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># to parse options, like --config GDAL_NUM_THREADS update here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                
        <span class="k">def</span> <span class="nf">_run_gdal_grid</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;reuse if running multiple layers&quot;&quot;&quot;</span>
            <span class="n">existing_layers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">existing_layers</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;column </span><span class="si">{}</span><span class="s1"> does not exist in input CSV:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                   <span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">),</span>
                     <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Skipping interpolation.&#39;</span>
               <span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># move to out_dir to run gdal command</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
            <span class="c1"># build vrt files in out_dir </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_pt_vrt</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>
            
            <span class="n">vrt_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.vrt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">tiff_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.tiff&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="c1"># add raster path to instance if not already there (overwritten)</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">out_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">tiff_file</span><span class="p">)</span>
            <span class="c1"># print message to console/logging about interpolation</span>
            <span class="n">grid_var</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_summ&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># recalculate raster resolution from bounds</span>
            <span class="n">n4km_xcells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">/</span> <span class="n">InterpGdal</span><span class="o">.</span><span class="n">CELL_SIZE</span><span class="p">))</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">n4km_xcells</span> <span class="o">/</span> <span class="n">nx_cells</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">scale_factor</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">_interp_msg</span><span class="p">(</span><span class="n">grid_var</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_meth</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span> 
            <span class="c1"># build command line arguments</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;gdal_grid -a </span><span class="si">{meth}{p}</span><span class="s1"> -txe </span><span class="si">{xmin}</span><span class="s1"> </span><span class="si">{xmax}</span><span class="s1"> -tye </span><span class="si">{ymax}</span><span class="s1">&#39;</span> 
                  <span class="s1">&#39; </span><span class="si">{ymin}</span><span class="s1"> -outsize </span><span class="si">{nx}</span><span class="s1"> </span><span class="si">{ny}</span><span class="s1"> -of GTiff -ot Float64 -l </span><span class="si">{source}</span><span class="s1">&#39;</span>
                  <span class="s1">&#39; </span><span class="si">{vrt}</span><span class="s1"> </span><span class="si">{out}</span><span class="s1"> </span><span class="si">{options}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meth</span><span class="o">=</span><span class="n">interp_meth</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">param_str</span><span class="p">,</span>
                      <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx_cells</span><span class="p">,</span> 
                      <span class="n">ny</span><span class="o">=</span><span class="n">ny_cells</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">vrt</span><span class="o">=</span><span class="n">vrt_file</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tiff_file</span><span class="p">,</span> 
                      <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="c1"># run gdal_grid with arguments, x-platform</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">out_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interped_rasters</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">interped_rasters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

            <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
         
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

            <span class="c1"># calculate interpolated values and error at stations</span>
            <span class="n">calc_pt_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">grid_var</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zonal_stats</span><span class="p">:</span>
                <span class="n">gridmet_zonal_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_csv_path</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>

            
        <span class="c1"># run interpolation and zonal statistics depending on layer kwarg</span>
        <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="c1"># potential for multiprocessing </span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">_run_gdal_grid</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="c1"># run single field</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">_run_gdal_grid</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="c1"># run select list or tuple of layers</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span>
                <span class="n">_run_gdal_grid</span><span class="p">(</span><span class="n">l</span><span class="p">)</span></div></div>
                
                
<span class="k">def</span> <span class="nf">_prettify</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an indented, multiline XML string for a XML element tree.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rough_string</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">)</span>
    <span class="n">reparsed</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">rough_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reparsed</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_interp_msg</span><span class="p">(</span><span class="n">grid_var</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interpolating </span><span class="si">{g}</span><span class="s1"> point bias ratios for: </span><span class="si">{t}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="n">grid_var</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">layer</span><span class="p">),</span>
        <span class="s1">&#39;Using the &quot;</span><span class="si">{}</span><span class="s1">&quot; method</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function</span><span class="p">),</span>
        <span class="s1">&#39;Resolution (pixel size) of output raster: </span><span class="si">{}</span><span class="s1"> m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;GeoTIFF raster will be saved to: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, John Volk and Chris Pearson

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>